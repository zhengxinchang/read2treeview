<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Tree with Pie Chart Nodes (Left to Right)</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
    .node text {
      font-size: 10px;
      text-anchor: middle;
      dominant-baseline: middle;
    }
  </style>
</head>
<body>
<svg width="1200" height="1000"></svg>
<script>
const width = 1200;
const height = 1000;

const svg = d3.select("svg")
  .attr("viewBox", [0, 0, width, height])
  .call(d3.zoom()
    .scaleExtent([0.3, 5])
    .on("zoom", (event) => {
      g.attr("transform", event.transform);
    }));

const g = svg.append("g").attr("transform", "translate(80,80)");
const color = d3.scaleOrdinal(d3.schemeCategory10);

d3.json("tree_output.json").then(data => {
  const root = d3.hierarchy(data);


  

  const treeLayout = d3.tree()
    .size([height - 160, width - 160])  // 注意顺序：[y, x] => 左到右
    .separation((a, b) => {
      const r1 = a.data.radius || 3;
      const r2 = b.data.radius || 3;
      return (r1 + r2 + 10) / 10;
    });

  treeLayout(root);

  // 直角连接线：先横再竖
  g.selectAll(".link")
    .data(root.links())
    .enter().append("path")
    .attr("class", "link")
    .attr("d", d => `
      M${d.source.y},${d.source.x}
      H${d.target.y}
      V${d.target.x}
    `);

  const node = g.selectAll(".node")
    .data(root.descendants())
    .enter().append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${d.y},${d.x})`);

  node.each(function(d) {
    const pieData = d.data.pieValues || [1];
    const nodeRadius = d.data.radius || 3;
    const pie = d3.pie()(pieData);
    const arc = d3.arc().innerRadius(0).outerRadius(nodeRadius);

    d3.select(this)
      .selectAll("path")
      .data(pie)
      .enter()
      .append("path")
      .attr("d", arc)
      .attr("fill", (d, i) => color(i));
  });

  // 可选标签
  // node.append("text")
  //   .attr("dx", d => d.data.radius + 8)
  //   .attr("dy", "0.35em")
  //   .text(d => d.data.name);
});
</script>
</body>
</html>
