<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>D3 Tree with Pie Chart Nodes (Cartesian)</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .node text {
            font-size: 10px;
            text-anchor: middle;
            dominant-baseline: middle;
        }
    </style>
</head>

<body>
    <svg width="1200" height="1000"></svg>
    <script>
        const width = 1500;
        const height = 1000;

        const svg = d3.select("svg")
            .attr("viewBox", [0, 0, width, height])
            .call(d3.zoom()
                .scaleExtent([0.3, 5])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }));

        const g = svg.append("g").attr("transform", "translate(80,80)");
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        d3.json("tree_output.json").then(data => {
            const root = d3.hierarchy(data);



            function countDescendants(node) {
                if (!node.children || node.children.length === 0) {
                    node.data.nchild = 0;  // 没有子孙节点
                    return 0;
                }

                let count = 0;
                for (const child of node.children) {
                    count += 1 + countDescendants(child);  // 每个 child 本身 + 它的后代
                }

                node.data.nchild = count;
                return count;
            }

            countDescendants(root);


            let maxChildrenCount = 0;
            let minChildrenCount = Infinity;
            root.descendants().forEach(d => {
                if (d.data.nchild > maxChildrenCount) {
                    maxChildrenCount = d.data.nchild;
                }
                if (d.data.nchild < minChildrenCount) {
                    minChildrenCount = d.data.nchild;
                }
            });

            function scaleRadius(nleaf) {
                const minRadius = 3;
                const maxRadius = 10;

                // 平滑化处理，避免 sqrt(0)
                const scaled = Math.sqrt(nleaf + 1);

                // 找到 sqrt 范围的最大最小值用于归一化
                const minScaled = Math.sqrt(minChildrenCount + 1);
                const maxScaled = Math.sqrt(maxChildrenCount + 1);

                return ((scaled - minScaled) / (maxScaled - minScaled)) * (maxRadius - minRadius) + minRadius;
            }
            root.descendants().forEach(d => {
                d.data.radius = scaleRadius(d.data.nchild);
            });


            
            const treeLayout = d3.tree()
                .size([width, height])
                //   .size([height, width])
                .separation((a, b) => {
                    const r1 = a.data.radius * 2 || 3;
                    const r2 = b.data.radius * 2 || 3;
                    // 以节点半径总和加一个常数为距离
                    return (r1 + r2 + 10) / 8;
                });


            treeLayout(root);


            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    return `
      M${d.source.x},${d.source.y}
      V${d.target.y}
      H${d.target.x}
    `;
                });


            function makePiechartDescendants(node,metaname) {
                if (!node.children || node.children.length === 0) {
                
                    node.data.pieValues = [node.data.meta[metaname]];

                    return [node.data.meta[metaname]];
                }

                let PV = [node.data.meta[metaname]];
                for (const child of node.children) {

                    prv = makePiechartDescendants(child);  // 每个 child 本身 + 它的后代
                    PV = PV.concat(prv);
                }

                node.data.pieValues = PV;
                return PV;
            }

            makePiechartDescendants(root,"host");

            console.log(root);

            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);



            node.each(function (d) {
                const pieData = d.data.pieValues || [1];
                const nodeRadius = d.data.radius || 3;
                const pie = d3.pie()(pieData);
                const arc = d3.arc().innerRadius(0).outerRadius(nodeRadius);

                d3.select(this)
                    .selectAll("path")
                    .data(pie)
                    .enter()
                    .append("path")
                    .attr("d", arc)
                    .attr("fill", (d, i) => color(i));
            });

            // 可选标签
            // node.append("text")
            //   .attr("dy", d => d.data.radius + 12)
            //   .text(d => d.data.name);
        });
    </script>
</body>

</html>